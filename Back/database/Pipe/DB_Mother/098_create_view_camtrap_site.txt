CREATE view [dbo].V_dataCamTrap_With_equipSite
as 

SELECT  e.ID as equipID,S.UnicIdentifier
,cam.FK_Sensor as FK_Sensor
,m.Name as site_name
,M.Category as site_type
,e.StartDate as StartDate
,e3.StartDate EndDate
,count (distinct cam.pk_id) as nb_photo

from [ecoReleve_Sensor].[dbo].[TcameraTrap] cam
LEFT JOIN Equipment E on e.FK_Sensor = cam.FK_Sensor and e.Deploy =1 and e.StartDate < cam.[date_creation]
					and not exists (select * 
									from  [Equipment] e2 
									where e2.FK_Sensor = e.FK_Sensor AND e2.StartDate > e.StartDate AND e2.StartDate < cam.[date_creation])
LEFT JOIN MonitoredSite M on e.FK_MonitoredSite = M.id
LEFT JOIN Sensor S on cam.FK_Sensor = S.ID
LEFT JOIN Equipment E3 on e3.FK_Sensor = cam.FK_Sensor and e3.Deploy =0 and e3.StartDate > e.StartDate 
							and not exists (select * 
									from  [Equipment] e4 
									where e4.FK_Sensor = e.FK_Sensor AND e4.StartDate < e3.StartDate and e4.StartDate > e.StartDate)
where cam.checked = 0
GROUP BY S.UnicIdentifier,m.Name,m.Category,e.StartDate,e3.StartDate,e.ID,cam.FK_Sensor

GO


INSERT INTO [dbo].[TVersion] (TVer_FileName,TVer_Date,TVer_DbName) VALUES ('68_create_view_camtrap_site',GETDATE(),(SELECT db_name()))


GO
