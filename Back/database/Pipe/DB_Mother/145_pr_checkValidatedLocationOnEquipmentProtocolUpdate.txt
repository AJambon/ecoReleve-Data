SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[pr_checkValidatedLocationOnEquipmentProtocolUpdate]
 @obsID int,
 @newFk_Sensor int,
 @newFK_Indiv int,
 @result int OUTPUT
   AS
   BEGIN

	SET NOCOUNT ON
	DECLARE
	@StartDate datetime,
	@EndDate datetime,
	@stationDate datetime,
	@FK_Sensor int,
	@Fk_Individual int


	SELECT @FK_Sensor = ValueInt	
	FROM ObservationDynPropValuesNow
	WHERE FK_Observation = @obsID 
	AND Name = 'FK_Sensor'

	SELECT @Fk_Individual = FK_Individual
	FROM Observation 
	WHERE ID = @obsID

	IF @Fk_Individual IS NULL
	SET @Fk_Individual = 0

	IF @newFK_Indiv IS NULL
	SET @newFK_Indiv = 0

	IF (@FK_Individual != @newFK_Indiv OR @FK_Sensor != @newFk_Sensor)
	BEGIN

		select @stationDate=StationDate
		FROM Station s
		WHERE EXISTS (SELECT * 
						FROM Observation o where o.FK_Station = s.ID AND o.ID = @obsID)

		select @StartDate = StartDate , @EndDate = EndDate 
		from SensorEquipment
		where FK_Sensor =  @FK_sensor
		and  (@stationDate >= StartDate and (EndDate is null or  @stationDate <=  EndDate ) )


		SELECT @result = 1 WHERE EXISTS (select *from Individual_Location where
			date >= @StartDate
			and (@EndDate is null or date <=  @EndDate )
			and FK_sensor = @FK_sensor )
	END

	SELECT @result

END
GO


INSERT INTO [dbo].[TVersion] (TVer_FileName,TVer_Date,TVer_DbName) VALUES ('145_pr_checkValidatedLocationOnEquipmentProtocolUpdate',GETDATE(),(SELECT db_name()))


GO
